<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Gym Log">
    <title>Gym Assistant</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; background: #111; color: #eee; }
        h1 { font-size: 20px; }
        input { width: 100%; padding: 12px; font-size: 16px; background: #222; border: 2px solid #444; color: #eee; margin-bottom: 10px; }
        button { padding: 12px; font-size: 16px; background: #0f8; border: none; color: #000; font-weight: bold; cursor: pointer; }
        #logButton { width: 100%; padding: 12px; font-size: 16px; background: #0f8; border: none; color: #000; font-weight: bold; cursor: pointer; }
        #msg { padding: 15px; background: #222; margin: 20px 0; border-left: 4px solid #0f8; }
        #msg.typing::after { content: '‚ñå'; animation: blink 0.7s infinite; margin-left: 2px; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        .item { background: #222; padding: 10px; margin: 10px 0; border-left: 3px solid #444; display: flex; justify-content: space-between; align-items: center; }
        .item.in-progress { border-left: 3px solid #0f8; background: #1a2a1a; }
        .item-content { flex: 1; }
        .ex { color: #0f8; font-weight: bold; }
        .dt { color: #888; font-size: 12px; }
        .workout-separator { margin: 20px 0 10px 0; padding: 8px 0; border-top: 2px solid #444; }
        .workout-label { color: #888; font-size: 13px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        #install { background: #f80; padding: 15px; margin-bottom: 20px; border-radius: 8px; display: none; }
        #install button { background: #000; color: #f80; margin-top: 10px; }
        .del { background: #f44; color: #fff; border: none; padding: 8px 12px; cursor: pointer; font-size: 14px; border-radius: 4px; }
        .del:hover { background: #f66; }
    </style>
</head>
<body>
    <div id="install" style="display: none;">
        <strong>‚ö†Ô∏è Add to Home Screen</strong>
        <p>Safari deletes data after 7 days. Add this to your home screen to save workouts permanently!</p>
        <p style="font-size: 14px; margin-top: 10px;">Tap Share ‚Üí Add to Home Screen</p>
        <button onclick="document.getElementById('install').style.display='none'">Dismiss</button>
    </div>
    <h1>üí™ (Dead Simple) Gym Log</h1>
    <input id="i" placeholder="bench 8, 8, 7 x 100" autofocus>
    <button id="logButton" onclick="log()">Log</button>
    <div id="msg"></div>
    <div id="hist"></div>
    <script src="js/inputParser.js"></script>
    <script>
        const get = () => JSON.parse(localStorage.getItem('w') || '[]');
        const save = w => localStorage.setItem('w', JSON.stringify([...get(), w]));
        const saveAll = w => localStorage.setItem('w', JSON.stringify(w));

        const toKg = (wt, unit) => (unit === 'lbs' || unit === 'lb') ? wt * 0.453592 : wt;
        const totalReps = (reps) => reps.reduce((a, b) => a + b, 0);

        function isHeavier(current, previous) {
            return toKg(current.wt, current.unit) > toKg(previous.wt, previous.unit);
        }

        // Create parser instance (InputParser is loaded from external file)
        const inputParser = new InputParser();

        function endWorkout() {
            const all = get();
            const unassigned = all.filter(x => !x.workout_id);

            if (unassigned.length === 0) {
                msg('No exercises to end. Start logging some exercises first! üí™');
                return;
            }

            // Use first exercise date as workout ID, assign to all unassigned
            const workoutId = unassigned[0].date;
            all.forEach(ex => { if (!ex.workout_id) ex.workout_id = workoutId; });

            saveAll(all);
            msg(`Workout ended! üéâ ${unassigned.length} exercise${unassigned.length > 1 ? 's' : ''} saved.`);
            show();
        }

        function comparePerformance(current, previous) {
            const currTotal = totalReps(current.reps);
            const prevTotal = totalReps(previous.reps);

            if (isHeavier(current, previous)) return 'üí™ Heavier!';
            if (currTotal > prevTotal) return 'üìà More reps!';
            if (isHeavier(previous, current)) return 'üòì Lighter';
            if (currTotal < prevTotal) return 'üòì Fewer reps';
            return 'üëç Same';
        }

        function log() {
            const input = document.getElementById('i');
            const w = inputParser.parse(input.value);
            if (!w) {
                msg('Bad format. Try: "squat 5,5 x 100 kg" or "squat 10,8,6 x 225 lbs" or "end workout"');
                return;
            }

            input.value = '';

            // Handle commands
            if (w.type === 'command') {
                if (w.action === 'end_workout') endWorkout();
                return;
            }

            // Handle exercises
            const hist = get().filter(x => x.ex === w.ex);
            const last = hist[hist.length - 1];

            save(w);

            if (!last) {
                msg(`${w.ex}: First time! üéâ`);
            } else {
                const comparison = comparePerformance(w, last);
                msg(`Last: ${last.reps.join(',')} x ${last.wt} ${last.unit}. ${comparison}`);
            }

            show();
        }

        function del(index) {
            const all = get();
            all.splice(index, 1);
            saveAll(all);
            msg('Entry deleted');
            show();
        }

        function msg(t) { 
            const msgEl = document.getElementById('msg');
            msgEl.textContent = '';
            msgEl.classList.add('typing');
            const chars = Array.from(t);
            let i = 0, typoMade = false;
            const type = () => {
                if (i >= chars.length) return setTimeout(() => msgEl.classList.remove('typing'), 1000);
                const isLetter = /[a-zA-Z]/.test(chars[i]);
                const typo = !typoMade && isLetter && Math.random() < 0.08 && i > 0;
                if (typo) {
                    typoMade = true;
                    const letters = 'abcdefghijklmnopqrstuvwxyz'.replace(chars[i].toLowerCase(), '');
                    const wrong = letters[Math.floor(Math.random() * letters.length)];
                    const beforeTypo = msgEl.textContent;
                    msgEl.textContent += wrong;
                    setTimeout(() => { msgEl.textContent = beforeTypo; setTimeout(() => { msgEl.textContent += chars[i++]; type(); }, 200); }, 300);
                } else {
                    msgEl.textContent += chars[i++];
                    setTimeout(type, 20 + Math.random() * 80);
                }
            };
            type();
        }

        function renderWorkoutSeparator(workoutId) {
            const label = workoutId
                ? `Workout - ${new Date(workoutId).toLocaleDateString()}`
                : 'Workout - In progress';
            return `<div class="workout-separator">
                <div class="workout-label">${label}</div>
            </div>`;
        }

        function renderExercise(exercise, index) {
            const inProgress = !exercise.workout_id ? 'in-progress' : '';
            return `<div class="item ${inProgress}">
                <div class="item-content">
                    <div class="ex">${exercise.ex}</div>
                    <div>${exercise.reps.join(', ')} √ó ${exercise.wt} ${exercise.unit}</div>
                    <div class="dt">${new Date(exercise.date).toLocaleString()}</div>
                </div>
                <button class="del" onclick="del(${index})">üóëÔ∏è</button>
            </div>`;
        }

        function show() {
            const all = get();
            const recent = all.slice(-20).reverse();

            let html = '';
            let lastWorkoutId = undefined;

            recent.forEach((exercise, i) => {
                const actualIndex = all.length - 1 - i;

                // Add separator when workout changes
                if (exercise.workout_id !== lastWorkoutId) {
                    html += renderWorkoutSeparator(exercise.workout_id);
                    lastWorkoutId = exercise.workout_id;
                }

                html += renderExercise(exercise, actualIndex);
            });

            document.getElementById('hist').innerHTML = html;
        }

        document.getElementById('i').addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                log();
            }
        });
        // Detect if running in Safari on iOS (not already installed)
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isStandalone = window.navigator.standalone === true;

        // Show warning every time on iOS Safari unless running as standalone app
        if (isIOS && !isStandalone) {
            document.getElementById('install').style.display = 'block';
        }
        
        const quotes = ['Ready to crush it? üí™', 'Log your lifts! üèãÔ∏è', 'Track your progress üìä', 'Every rep counts! üî•', 'Time to get strong üíØ'];
        msg(quotes[Math.floor(Math.random() * quotes.length)]);
        show();
    </script>
</body>
</html>
